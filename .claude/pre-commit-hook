#!/bin/bash
# Pre-commit hook: Self-reflection checklist
# Ensures changes align with repo goals before committing

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸ” Running self-reflection checks...${NC}"

# Get list of staged Python files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No Python files staged${NC}"
    exit 0
fi

# Counter for violations
VIOLATIONS=0

# Check 1: Hard-coded customer/platform names
echo -e "\n${YELLOW}Checking for hard-coded customer/platform names...${NC}"
if git diff --cached | grep -E '^\+.*customer\s*=\s*["\x27](moprobo|ecoflow|test)' | grep -v 'customer=' | grep -v 'customer:' > /dev/null; then
    echo -e "${RED}âœ— Found hard-coded customer names${NC}"
    echo "  Use --customer parameter instead"
    VIOLATIONS=$((VIOLATIONS + 1))
fi

if git diff --cached | grep -E '^\+.*platform\s*=\s*["\x27](meta|google|tiktok)' | grep -v 'platform=' | grep -v 'platform:' > /dev/null; then
    echo -e "${RED}âœ— Found hard-coded platform names${NC}"
    echo "  Use --platform parameter instead"
    VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check 2: Hard-coded file paths
echo -e "${YELLOW}Checking for hard-coded file paths...${NC}"
BAD_PATHS=$(git diff --cached | grep -E '^\+.*Path\(["\x27](datasets/|config/|results/)' || true)
if [ -n "$BAD_PATHS" ]; then
    echo -e "${RED}âœ— Found hard-coded paths${NC}"
    echo "  Use customer_paths.py helpers instead"
    echo "$BAD_PATHS"
    VIOLATIONS=$((VIOLATIONS + 1))
fi

# Check 3: Synthetic data claims in comments/docs
echo -e "${YELLOW}Checking for synthetic data claims...${NC}"
if git diff --cached | grep -i 'synthetic.*data\|simulation.*proof' | grep -v '^---' | grep -v '^+++' > /dev/null; then
    echo -e "${YELLOW}âš  Warning: Found references to synthetic data${NC}"
    echo "  Ensure evaluation uses real customer data"
fi

# Check 4: "Optimal" or "Perfect" claims
echo -e "${YELLOW}Checking for unrealistic claims...${NC}"
if git diff --cached | grep -iE 'optimal|perfect.*solution' | grep -v '^---' | grep -v '^+++' > /dev/null; then
    echo -e "${YELLOW}âš  Warning: Found claims of optimality/perfection${NC}"
    echo "  Goal is beating history, not perfection"
fi

# Check 5: CI workflow status (if Makefile exists)
if [ -f "Makefile" ]; then
    echo -e "${YELLOW}Checking if CI workflows pass...${NC}"
    echo "  Run 'make lint' before committing"
fi

# Summary
echo -e "\n${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ $VIOLATIONS -gt 0 ]; then
    echo -e "${RED}âœ— Found $VIOLATIONS violation(s)${NC}"
    echo -e "\n${YELLOW}Review .claude/SELF_REFLECTION.md for guidelines${NC}"
    exit 1
else
    echo -e "${GREEN}âœ“ All self-reflection checks passed${NC}"
    echo -e "${GREEN}âœ“ Changes align with repo goals${NC}"
    exit 0
fi
