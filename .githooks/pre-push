#!/bin/bash
# Pre-push hook to prevent direct pushes to main branch

# Color codes for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get the current branch name
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# Get the remote branch being pushed to
REMOTE="$1"
URL="$2"

echo "Checking pre-push rules..."

# Read stdin to see what refs are being pushed
while read LOCAL_REF LOCAL_SHA1 REMOTE_REF REMOTE_SHA1
do
    # Extract the remote branch name from refs/heads/branch-name
    REMOTE_BRANCH=$(echo "$REMOTE_REF" | sed 's|refs/heads/||')
    
    # Check if pushing to main or master
    if [[ "$REMOTE_BRANCH" == "main" ]] || [[ "$REMOTE_BRANCH" == "master" ]]; then
        echo ""
        echo "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo "${RED}ERROR: Direct push to '$REMOTE_BRANCH' branch is not allowed!${NC}"
        echo "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo "${YELLOW}Protected branches require a pull request workflow:${NC}"
        echo ""
        echo "  ${GREEN}1. Create a feature branch:${NC}"
        echo "     git checkout -b feature/your-feature-name"
        echo ""
        echo "  ${GREEN}2. Commit your changes:${NC}"
        echo "     git commit -m 'Your commit message'"
        echo ""
        echo "  ${GREEN}3. Push to feature branch:${NC}"
        echo "     git push -u origin feature/your-feature-name"
        echo ""
        echo "  ${GREEN}4. Create a pull request on GitHub${NC}"
        echo ""
        echo "  ${GREEN}5. Merge after review${NC}"
        echo ""
        echo "${YELLOW}⚠️  To bypass this check (not recommended):${NC}"
        echo "     git push --no-verify"
        echo ""
        echo "${RED}Push aborted.${NC}"
        echo ""
        exit 1
    fi
done

echo "${GREEN}✓ Pre-push checks passed${NC}"
exit 0
